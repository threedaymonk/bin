#!/usr/bin/env ruby
require 'mechanize'
require 'csv'

email, password = nil
config_file = File.join(ENV['HOME'], '.newnet')
eval(File.read(config_file), binding, config_file, 1)

agent = WWW::Mechanize.new

# Sign in
page = agent.get('https://orderform.co.uk/login/index.php?form=orac')
form = page.form('login')
form.emailaddress = email
form.password     = password
page = agent.submit(form, form.buttons.first)

# Go to bandwidth page
page = agent.get(page.search("//a").map{ |a| a['href'] }.find{ |h| h =~ /ADSLAccountDetails/ })

# Find 15px tds
tds = page.search("//td[@style='font-size: 15px']").map{ |a| a.inner_html }.select{ |h| h=~ /^<strong/ }

tds.each do |td|
  m = td.match(%r{ <strong>([^<]+)</strong> \s* ([\d\.]+) \s* (\D+) }x)
  key    = m[1]
  number = m[2].to_f
  units  = m[3]

  case key
  when /^included bandwidth allowance/i
    key = "Allowance"
  when /^pre-paid/i
    key = "Pre-paid"
  when /^peak usage/i
    key = "Peak usage"
  when /^off-peak usage/i
    key = "Off-peak usage"
  end

  # Uglier than necessary b/c left-padding is broken with %f
  puts "%s %s GB" % [(key + ":").ljust(16), ("%2.2f" % number).rjust(5)]
end
